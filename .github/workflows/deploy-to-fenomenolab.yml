name: Build VRound and publish to fenomenolab.co/vround

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout VRound repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build (Vite)
        run: npm run build
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Clone site repo (anaeusse.github.io)
        env:
          TOKEN: ${{ secrets.PAGES_PUSH_TOKEN }}
        run: |
          git clone https://x-access-token:${TOKEN}@github.com/anaeusse/anaeusse.github.io.git site

      - name: Replace /vround with new build
        run: |
          rm -rf site/vround
          mkdir -p site/vround
          cp -R dist/* site/vround/

      - name: Commit and push changes
        env:
          TOKEN: ${{ secrets.PAGES_PUSH_TOKEN }}
        run: |
          cd site
          git config user.name "vround-deploy-bot"
          git config user.email "vround-deploy-bot@users.noreply.github.com"

          git add vround

          # Si no hay cambios, que no falle el workflow
          git commit -m "Deploy VRound from ${GITHUB_REPOSITORY}@${GITHUB_SHA}" || echo "No changes to commit"

          git push origin main